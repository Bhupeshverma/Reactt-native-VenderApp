["47b2575f7ac6cf5c67f8c85439ab2b3fce681702","23586b27c19a0c21e77cf674da8a16a5eebd9d73",["sc-emitter","./response","querystring","ws","sc-errors"],[24,72,122,359,504],{"version":3,"sources":["/home/ziddi/Desktop/Bhupesh/venders/node_modules/socketcluster-client/lib/sctransport.js"],"names":["SCEmitter","require","Response","querystring","WebSocket","createWebSocket","global","uri","options","scErrors","TimeoutError","SCTransport","authEngine","codecEngine","state","CLOSED","auth","codec","connectTimeout","pingTimeout","ackTimeout","callIdGenerator","_pingTimeoutTicker","_callbackMap","open","prototype","Object","create","CONNECTING","OPEN","query","schema","secure","timestampRequests","timestampParam","Date","getTime","encode","length","host","port","hostname","path","self","wsSocket","binaryType","socket","onopen","_onOpen","onclose","event","code","_onClose","reason","onmessage","message","flags","_onMessage","data","onerror","error","_connectTimeoutRef","setTimeout","close","clearTimeout","_resetPingTimeout","_handshake","err","status","_onError","emit","call","callback","loadToken","authTokenName","token","force","authToken","authError","hydrateError","obj","decode","readyState","sendObject","response","cid","rid","eventObject","timeout","rehydratedError","now","getBytesReceived","bytesReceived","packet","emitObject","simpleEventObject","_handleEventAckTimeout","errorMessage","a","b","Function","noTimeout","cancelPendingResponse","object","send","serializeObject","str","formatError","module","exports"],"mappings":"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","sourcesContent":["var SCEmitter = require('sc-emitter').SCEmitter;\nvar Response = require('./response').Response;\nvar querystring = require('querystring');\nvar WebSocket;\nvar createWebSocket;\n\nif (global.WebSocket) {\n  WebSocket = global.WebSocket;\n  createWebSocket = function (uri, options) {\n    return new WebSocket(uri);\n  };\n} else {\n  WebSocket = require('ws');\n  createWebSocket = function (uri, options) {\n    return new WebSocket(uri, null, options);\n  };\n}\n\nvar scErrors = require('sc-errors');\nvar TimeoutError = scErrors.TimeoutError;\n\n\nvar SCTransport = function (authEngine, codecEngine, options) {\n  this.state = this.CLOSED;\n  this.auth = authEngine;\n  this.codec = codecEngine;\n  this.options = options;\n  this.connectTimeout = options.connectTimeout;\n  this.pingTimeout = options.ackTimeout;\n  this.callIdGenerator = options.callIdGenerator;\n\n  this._pingTimeoutTicker = null;\n  this._callbackMap = {};\n\n  this.open();\n};\n\nSCTransport.prototype = Object.create(SCEmitter.prototype);\n\nSCTransport.CONNECTING = SCTransport.prototype.CONNECTING = 'connecting';\nSCTransport.OPEN = SCTransport.prototype.OPEN = 'open';\nSCTransport.CLOSED = SCTransport.prototype.CLOSED = 'closed';\n\nSCTransport.prototype.uri = function () {\n  var query = this.options.query || {};\n  var schema = this.options.secure ? 'wss' : 'ws';\n\n  if (this.options.timestampRequests) {\n    query[this.options.timestampParam] = (new Date()).getTime();\n  }\n\n  query = querystring.encode(query);\n\n  if (query.length) {\n    query = '?' + query;\n  }\n\n  var host;\n  if (this.options.host) {\n    host = this.options.host;\n  } else {\n    var port = '';\n\n    if (this.options.port && ((schema == 'wss' && this.options.port != 443)\n      || (schema == 'ws' && this.options.port != 80))) {\n      port = ':' + this.options.port;\n    }\n    host = this.options.hostname + port;\n  }\n\n  return schema + '://' + host + this.options.path + query;\n};\n\nSCTransport.prototype.open = function () {\n  var self = this;\n\n  this.state = this.CONNECTING;\n  var uri = this.uri();\n\n  var wsSocket = createWebSocket(uri, this.options);\n  wsSocket.binaryType = this.options.binaryType;\n  this.socket = wsSocket;\n\n  wsSocket.onopen = function () {\n    self._onOpen();\n  };\n\n  wsSocket.onclose = function (event) {\n    var code;\n    if (event.code == null) {\n      // This is to handle an edge case in React Native whereby\n      // event.code is undefined when the mobile device is locked.\n      // TODO: This is not perfect since this condition could also apply to\n      // an abnormal close (no close control frame) which would be a 1006.\n      code = 1005;\n    } else {\n      code = event.code;\n    }\n    self._onClose(code, event.reason);\n  };\n\n  wsSocket.onmessage = function (message, flags) {\n    self._onMessage(message.data);\n  };\n\n  wsSocket.onerror = function (error) {\n    // The onclose event will be called automatically after the onerror event\n    // if the socket is connected - Otherwise, if it's in the middle of\n    // connecting, we want to close it manually with a 1006 - This is necessary\n    // to prevent inconsistent behavior when running the client in Node.js\n    // vs in a browser.\n\n    if (self.state === self.CONNECTING) {\n      self._onClose(1006);\n    }\n  };\n\n  this._connectTimeoutRef = setTimeout(function () {\n    self._onClose(4007);\n    self.socket.close(4007);\n  }, this.connectTimeout);\n};\n\nSCTransport.prototype._onOpen = function () {\n  var self = this;\n\n  clearTimeout(this._connectTimeoutRef);\n  this._resetPingTimeout();\n\n  this._handshake(function (err, status) {\n    if (err) {\n      self._onError(err);\n      self._onClose(4003);\n      self.socket.close(4003);\n    } else {\n      self.state = self.OPEN;\n      SCEmitter.prototype.emit.call(self, 'open', status);\n      self._resetPingTimeout();\n    }\n  });\n};\n\nSCTransport.prototype._handshake = function (callback) {\n  var self = this;\n  this.auth.loadToken(this.options.authTokenName, function (err, token) {\n    if (err) {\n      callback(err);\n    } else {\n      // Don't wait for this.state to be 'open'.\n      // The underlying WebSocket (this.socket) is already open.\n      var options = {\n        force: true\n      };\n      self.emit('#handshake', {\n        authToken: token\n      }, options, function (err, status) {\n        if (status) {\n          // Add the token which was used as part of authentication attempt\n          // to the status object.\n          status.authToken = token;\n          if (status.authError) {\n            status.authError = scErrors.hydrateError(status.authError);\n          }\n        }\n        callback(err, status);\n      });\n    }\n  });\n};\n\nSCTransport.prototype._onClose = function (code, data) {\n  delete this.socket.onopen;\n  delete this.socket.onclose;\n  delete this.socket.onmessage;\n  delete this.socket.onerror;\n\n  clearTimeout(this._connectTimeoutRef);\n\n  if (this.state == this.OPEN) {\n    this.state = this.CLOSED;\n    SCEmitter.prototype.emit.call(this, 'close', code, data);\n\n  } else if (this.state == this.CONNECTING) {\n    this.state = this.CLOSED;\n    SCEmitter.prototype.emit.call(this, 'openAbort', code, data);\n  }\n};\n\nSCTransport.prototype._onMessage = function (message) {\n  SCEmitter.prototype.emit.call(this, 'event', 'message', message);\n\n  var obj = this.decode(message);\n\n  // If ping\n  if (obj == '#1') {\n    this._resetPingTimeout();\n    if (this.socket.readyState == this.socket.OPEN) {\n      this.sendObject('#2');\n    }\n  } else {\n    var event = obj.event;\n\n    if (event) {\n      var response = new Response(this, obj.cid);\n      SCEmitter.prototype.emit.call(this, 'event', event, obj.data, response);\n    } else if (obj.rid != null) {\n\n      var eventObject = this._callbackMap[obj.rid];\n      if (eventObject) {\n        clearTimeout(eventObject.timeout);\n        delete this._callbackMap[obj.rid];\n\n        if (eventObject.callback) {\n          var rehydratedError = scErrors.hydrateError(obj.error);\n          eventObject.callback(rehydratedError, obj.data);\n        }\n      }\n    } else {\n      SCEmitter.prototype.emit.call(this, 'event', 'raw', obj);\n    }\n  }\n};\n\nSCTransport.prototype._onError = function (err) {\n  SCEmitter.prototype.emit.call(this, 'error', err);\n};\n\nSCTransport.prototype._resetPingTimeout = function () {\n  var self = this;\n\n  var now = (new Date()).getTime();\n  clearTimeout(this._pingTimeoutTicker);\n\n  this._pingTimeoutTicker = setTimeout(function () {\n    self._onClose(4000);\n    self.socket.close(4000);\n  }, this.pingTimeout);\n};\n\nSCTransport.prototype.getBytesReceived = function () {\n  return this.socket.bytesReceived;\n};\n\nSCTransport.prototype.close = function (code, data) {\n  code = code || 1000;\n\n  if (this.state == this.OPEN) {\n    var packet = {\n      code: code,\n      data: data\n    };\n    this.emit('#disconnect', packet);\n\n    this._onClose(code, data);\n    this.socket.close(code);\n\n  } else if (this.state == this.CONNECTING) {\n    this._onClose(code, data);\n    this.socket.close(code);\n  }\n};\n\nSCTransport.prototype.emitObject = function (eventObject) {\n  var simpleEventObject = {\n    event: eventObject.event,\n    data: eventObject.data\n  };\n\n  if (eventObject.callback) {\n    simpleEventObject.cid = eventObject.cid = this.callIdGenerator();\n    this._callbackMap[eventObject.cid] = eventObject;\n  }\n\n  this.sendObject(simpleEventObject);\n  return eventObject.cid || null;\n};\n\nSCTransport.prototype._handleEventAckTimeout = function (eventObject) {\n  var errorMessage = \"Event response for '\" + eventObject.event + \"' timed out\";\n  var error = new TimeoutError(errorMessage);\n\n  if (eventObject.cid) {\n    delete this._callbackMap[eventObject.cid];\n  }\n  var callback = eventObject.callback;\n  delete eventObject.callback;\n  callback.call(eventObject, error, eventObject);\n};\n\n// The last two optional arguments (a and b) can be options and/or callback\nSCTransport.prototype.emit = function (event, data, a, b) {\n  var self = this;\n\n  var callback, options;\n\n  if (b) {\n    options = a;\n    callback = b;\n  } else {\n    if (a instanceof Function) {\n      options = {};\n      callback = a;\n    } else {\n      options = a;\n    }\n  }\n\n  var eventObject = {\n    event: event,\n    data: data,\n    callback: callback\n  };\n\n  if (callback && !options.noTimeout) {\n    eventObject.timeout = setTimeout(function () {\n      self._handleEventAckTimeout(eventObject);\n    }, this.options.ackTimeout);\n  }\n\n  var cid = null;\n  if (this.state == this.OPEN || options.force) {\n    cid = this.emitObject(eventObject);\n  }\n  return cid;\n};\n\nSCTransport.prototype.cancelPendingResponse = function (cid) {\n  delete this._callbackMap[cid];\n};\n\nSCTransport.prototype.decode = function (message) {\n  return this.codec.decode(message);\n};\n\nSCTransport.prototype.encode = function (object) {\n  return this.codec.encode(object);\n};\n\nSCTransport.prototype.send = function (data) {\n  if (this.socket.readyState != this.socket.OPEN) {\n    this._onClose(1005);\n  } else {\n    this.socket.send(data);\n  }\n};\n\nSCTransport.prototype.serializeObject = function (object) {\n  var str, formatError;\n  try {\n    str = this.encode(object);\n  } catch (err) {\n    formatError = err;\n    this._onError(formatError);\n  }\n  if (!formatError) {\n    return str;\n  }\n  return null;\n};\n\nSCTransport.prototype.sendObject = function (object) {\n  var str = this.serializeObject(object);\n  if (str != null) {\n    this.send(str);\n  }\n};\n\nmodule.exports.SCTransport = SCTransport;\n"]}]